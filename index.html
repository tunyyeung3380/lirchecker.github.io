<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Cargo Load Planner</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    textarea { width: 100%; height: 150px; }
    button { margin: 10px 5px; padding: 8px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    th { background-color: #f2f2f2; }
    #report { margin-top: 30px; }
  </style>
</head>
<body>
  <h2>Cargo Manifest Parser & Load Planner</h2>
  <p>Paste your email title and cargo manifest below:</p>
  <textarea id="manifestInput"></textarea><br>
  <button onclick="parseManifest()">Parse Manifest</button>
  <button onclick="generateReport()">Submit & Generate Load Report</button>

  <div id="headerInfo"></div>

  <table id="cargoTable">
    <thead>
      <tr>
        <th>UNIT</th><th>TYPE</th><th>PCS</th><th>WT/KG</th>
        <th>CTUR</th><th>PR</th><th>SPECIAL HANDLING</th><th>REMARKS</th><th>Compartment</th>
      </tr>
    </thead>
    <tbody></tbody>
    <tfoot>
      <tr>
        <th colspan="2">TOTAL</th>
        <th id="totalPCS">0</th>
        <th id="totalWT">0</th>
        <th colspan="5"></th>
      </tr>
    </tfoot>
  </table>

  <div id="report"></div>

  <script>
    let cargoData = [];
    let headerInfo = {};

    function parseManifest() {
      const text = document.getElementById('manifestInput').value.trim();
      const lines = text.split(/\n/).filter(l => l.trim() !== "");

      cargoData = [];
      headerInfo = {};

      // First line may be the email title
      if (lines[0].startsWith("FINAL LOAD")) {
        const headerParts = lines[0].split(/\s+/);
        // Format: FINAL LOAD UO114/16JAN26/HKGTPE
        if (headerParts.length >= 3) {
          const flightInfo = headerParts[2].split("/");
          headerInfo.flightNo = flightInfo[0];
          headerInfo.date = flightInfo[1];
          headerInfo.sector = flightInfo[2];
        }
        lines.shift(); // remove header line from cargo parsing
      }

      lines.forEach(line => {
        const parts = line.trim().split(/\s+/);

        // Skip DEST if present
        let startIndex = 0;
        if (!/^[A-Z]{2,3}\d/.test(parts[0])) {
          startIndex = 1;
        }

        const unit = parts[startIndex];
        const pcs = parseInt(parts[startIndex + 2]) || 0;
        const wt = parseInt(parts[startIndex + 3]) || 0;

        // Skip headers, TTL, and malformed/zero rows
        if (!unit || unit === "TTL" || pcs === 0 || wt === 0) return;

        cargoData.push({
          UNIT: unit,
          TYPE: parts[startIndex + 1] || "",
          PCS: pcs,
          WT: wt,
          CTUR: parts[startIndex + 4] || "",
          PR: parts[startIndex + 5] || "",
          HANDLING: (parts[startIndex + 6] && parts[startIndex + 6].includes("ELI")) ? "ELI" : "NONE",
          REMARKS: parts.slice(startIndex + 7).join(" "),
          COMP: "H1" // default compartment
        });
      });

      renderHeader();
      renderTable();
      updateTotals();
    }

    function renderHeader() {
      if (headerInfo.flightNo) {
        document.getElementById("headerInfo").innerHTML =
          `<h3>Flight Information</h3>
           <p><b>Flight No:</b> ${headerInfo.flightNo}</p>
           <p><b>Date:</b> ${headerInfo.date}</p>
           <p><b>Sector:</b> ${headerInfo.sector}</p>`;
      }
    }

    function renderTable() {
      const tbody = document.querySelector("#cargoTable tbody");
      tbody.innerHTML = "";

      cargoData.forEach((row, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${row.UNIT}</td><td>${row.TYPE}</td><td>${row.PCS}</td>
                        <td>${row.WT}</td><td>${row.CTUR}</td><td>${row.PR}</td>
                        <td>${row.HANDLING}</td><td>${row.REMARKS}</td>
                        <td>
                          <select onchange="setCompartment(${idx}, this.value)">
                            <option value="H1">H1</option>
                            <option value="H2">H2</option>
                            <option value="H3">H3</option>
                            <option value="H4">H4</option>
                            <option value="H5">H5</option>
                            <option value="OFFLOAD">Offload</option>
                          </select>
                        </td>`;
        tbody.appendChild(tr);
      });
    }

    function setCompartment(index, value) {
      cargoData[index].COMP = value;
    }

    function updateTotals() {
      const totalPCS = cargoData.reduce((sum, r) => sum + r.PCS, 0);
      const totalWT = cargoData.reduce((sum, r) => sum + r.WT, 0);
      document.getElementById("totalPCS").textContent = totalPCS;
      document.getElementById("totalWT").textContent = totalWT;
    }

    function generateReport() {
  const reportDiv = document.getElementById("report");
  let compartments = {H1:{pcs:0,wt:0}, H2:{pcs:0,wt:0}, H3:{pcs:0,wt:0}, H4:{pcs:0,wt:0}, H5:{pcs:0,wt:0}};
  let offload = {pcs:0, wt:0};
  
  cargoData.forEach(r => {
    if (r.COMP === "OFFLOAD") {
      offload.pcs += r.PCS;
      offload.wt += r.WT;
    } else {
      compartments[r.COMP].pcs += r.PCS;
      compartments[r.COMP].wt += r.WT;
    }
  });

  // Calculate loaded totals (only H1â€“H5)
  const loadedPCS = Object.values(compartments).reduce((sum, c) => sum + c.pcs, 0);
  const loadedWT  = Object.values(compartments).reduce((sum, c) => sum + c.wt, 0);

  // Build load report
  let html = "<h3>Load Report</h3><table><tr><th>Compartment</th><th>PCS</th><th>Weight (KG)</th></tr>";
  Object.keys(compartments).forEach(c => {
    html += `<tr><td>${c}</td><td>${compartments[c].pcs}</td><td>${compartments[c].wt}</td></tr>`;
  });
  html += `<tr><th>Total Loaded</th><th>${loadedPCS}</th><th>${loadedWT}</th></tr></table>`;

  // Separate offload report
  html += "<h3>Offload Report</h3><table><tr><th>PCS</th><th>Weight (KG)</th></tr>";
  html += `<tr><td>${offload.pcs}</td><td>${offload.wt}</td></tr></table>`;

  reportDiv.innerHTML = html;
}

  </script>
</body>
</html>
