<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Cargo & Baggage Load Planner</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    textarea, input { margin: 5px; padding: 6px; }
    button { margin: 10px 5px; padding: 8px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    th { background-color: #f2f2f2; }
    #report { margin-top: 30px; }
  </style>
</head>
<body>
  <h2>Cargo & Baggage Load Planner</h2>
  <p>Paste your email title and cargo manifest below:</p>
  <textarea id="manifestInput"></textarea><br>
  <button onclick="parseManifest()">Parse Manifest</button>

  <h3>Baggage Input</h3>
  <label>PCS: <input type="number" id="bagPCS"></label>
  <label>Weight (KG): <input type="number" id="bagWT"></label>
  <button onclick="addBaggage()">Add Baggage</button>
  <p id="avgBag"></p>

  <button onclick="generateReport()">Submit & Generate Load Report</button>

  <table id="cargoTable">
    <thead>
      <tr>
        <th>UNIT</th><th>TYPE</th><th>PCS</th><th>WT/KG</th>
        <th>CTUR</th><th>PR</th><th>SPECIAL HANDLING</th><th>REMARKS</th><th>Compartment</th>
      </tr>
    </thead>
    <tbody></tbody>
    <tfoot>
      <tr>
        <th colspan="2">TOTAL</th>
        <th id="totalPCS">0</th>
        <th id="totalWT">0</th>
        <th colspan="5"></th>
      </tr>
    </tfoot>
  </table>

  <div id="report"></div>

  <script>
    let cargoData = [];
    let headerInfo = {};

    function parseManifest() {
      const text = document.getElementById('manifestInput').value.trim();
      const lines = text.split(/\n/).filter(l => l.trim() !== "");

      cargoData = [];
      headerInfo = {};

      // First line may be the email title
      if (lines[0].startsWith("FINAL LOAD")) {
        const headerParts = lines[0].split(/\s+/);
        if (headerParts.length >= 3) {
          const flightInfo = headerParts[2].split("/");
          headerInfo.flightNo = flightInfo[0];
          headerInfo.date = flightInfo[1];
          headerInfo.sector = flightInfo[2];
        }
        lines.shift();
      }

      lines.forEach(line => {
        const parts = line.trim().split(/\s+/);
        let startIndex = 0;
        if (!/^[A-Z]{2,3}\d/.test(parts[0])) {
          startIndex = 1;
        }

        const unit = parts[startIndex];
        const type = parts[startIndex + 1] || "";
        const pcs = parseInt(parts[startIndex + 2]) || 0;
        const wt = parseInt(parts[startIndex + 3]) || 0;

        if (!unit || unit === "TTL" || pcs === 0 || wt === 0) return;

        let handling = parts[startIndex + 6] || "";
        let typeLabel = type;
        if (handling.includes("ELI")) {
          typeLabel = `${type}-ELI`;
        }

        cargoData.push({
          UNIT: unit,
          TYPE: typeLabel,
          PCS: pcs,
          WT: wt,
          CTUR: parts[startIndex + 4] || "",
          PR: parts[startIndex + 5] || "",
          HANDLING: handling,
          REMARKS: parts.slice(startIndex + 7).join(" "),
          COMP: "H1"
        });
      });

      renderTable();
      updateTotals();
    }

    function addBaggage() {
      const pcs = parseInt(document.getElementById("bagPCS").value) || 0;
      const wt = parseInt(document.getElementById("bagWT").value) || 0;
      if (pcs <= 0 || wt <= 0) return;

      const avg = (wt / pcs).toFixed(2);
      document.getElementById("avgBag").textContent = `Average baggage weight: ${avg} kg per piece`;

      cargoData.push({
        UNIT: "BAGGAGE",
        TYPE: "B",
        PCS: pcs,
        WT: wt,
        CTUR: "",
        PR: "",
        HANDLING: "",
        REMARKS: "",
        COMP: "H1"
      });

      renderTable();
      updateTotals();
    }

    function renderTable() {
      const tbody = document.querySelector("#cargoTable tbody");
      tbody.innerHTML = "";

      cargoData.forEach((row, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${row.UNIT}</td><td>${row.TYPE}</td><td>${row.PCS}</td>
                        <td>${row.WT}</td><td>${row.CTUR}</td><td>${row.PR}</td>
                        <td>${row.HANDLING}</td><td>${row.REMARKS}</td>
                        <td>
                          <select onchange="setCompartment(${idx}, this.value)">
                            <option value="H1">H1</option>
                            <option value="H2">H2</option>
                            <option value="H3">H3</option>
                            <option value="H4">H4</option>
                            <option value="H5">H5</option>
                            <option value="OFFLOAD">Offload</option>
                          </select>
                        </td>`;
        tbody.appendChild(tr);
      });
    }

    function setCompartment(index, value) {
      cargoData[index].COMP = value;
    }

    function updateTotals() {
      const totalPCS = cargoData.reduce((sum, r) => sum + r.PCS, 0);
      const totalWT = cargoData.reduce((sum, r) => sum + r.WT, 0);
      document.getElementById("totalPCS").textContent = totalPCS;
      document.getElementById("totalWT").textContent = totalWT;
    }

    function generateReport() {
      const reportDiv = document.getElementById("report");
      let compartments = {H1:{pcs:0,wt:0,types:new Set()}, H2:{pcs:0,wt:0,types:new Set()}, H3:{pcs:0,wt:0,types:new Set()}, H4:{pcs:0,wt:0,types:new Set()}, H5:{pcs:0,wt:0,types:new Set()}};
      let offload = {pcs:0, wt:0};

      cargoData.forEach(r => {
        if (r.COMP === "OFFLOAD") {
          offload.pcs += r.PCS;
          offload.wt += r.WT;
        } else {
          compartments[r.COMP].pcs += r.PCS;
          compartments[r.COMP].wt += r.WT;
          compartments[r.COMP].types.add(r.TYPE);
        }
      });

      let html = "<h3>Load Report</h3><table><tr><th>Compartment</th><th>PCS</th><th>Weight (KG)</th><th>Type</th></tr>";
      Object.keys(compartments).forEach(c => {
        let typeLabel = "";
        const types = Array.from(compartments[c].types);
        if (types.length > 1) {
          typeLabel = types.join("/");
        } else {
          typeLabel = types[0] || "";
        }
        html += `<tr><td>${c}</td><td>${compartments[c].pcs}</td><td>${compartments[c].wt}</td><td>${typeLabel}</td></tr>`;
      });
